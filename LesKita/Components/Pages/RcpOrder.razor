@using LesKita.Components
<style>
    .page {
    background-color: #f9fafb;
    height: calc(100vh - 42px) !important;
    }

    .header {
    display: none !important;
    }

    .card-modern {
    background-color: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    padding: 16px;
    margin: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    font-family: 'Segoe UI', sans-serif;
    border: 1px solid #eee;
    }

    .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #fff;
    padding: 0rem 0rem 1rem 0rem !important;
    }

    .status-badge {

    font-size: 12px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 8px;
    }

    .status-badge.done {
    background-color: rgb(214, 255, 222);
    color: rgb(3, 172, 14);
    }

    .status-badge.waiting {
    background-color: #fdf5e6; /* krem lembut */
    color: #a67c00; /* cokelat kekuningan, cocok untuk status "menunggu" */
    }

    .status-badge.active {
    background-color: #d3e3fd; /* biru sedang */
    color: #588ddf; /* putih agar kontras dengan biru */
    }

    .status-badge.cancel {
    background-color: #ffeaef;
    color: #ef144a;
    }

    .time-label {
    color: #555;
    font-size: 12px;
    font-weight:700;
    padding: 4px 8px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
    }

    .card-content {
    display: flex;
    gap: 12px;
    }

    .card-content img {
    width: 64px;
    height: 64px;
    border-radius: 12px;
    object-fit: cover;
    }

    .card-info-title {
    font-weight: 600;
    color: #333;
    }

    .card-info-sub {
    font-size: 12px;
    color: #999;
    }

    .card-customer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    }

    .customer-info {
    display: flex;
    align-items: center;
    gap: 10px;
    }

    .customer-info img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    }

    .customer-name {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    }

    .customer-role {
    font-size: 10px;
    color: #888;
    }

    .card-footer {
    border-top: 1px solid #eee;
    font-size: 12px;
    color: #777;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #fff;
    padding: 10px 0rem 0rem 0rem !important;
    }

    .btn-action {
    background-color: #6282c8;
    color: white;
    font-size: 12px;
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    }

    .action-order{
    width: 35px;
    height: 35px;
    background-color: #f1f5f9;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    }

    .action-order span{
    cursor: pointer;
    font-size:18px;
    color: #6282c8;
    }

    .action-order:hover,
    .action-order:active
    {
    background-color: #6282c8;
    }

    .action-order span:hover,
    .action-order span:active
    {
    color: #fff;
    }
</style>
<style>
    .rating-place {
    display: flex;
    width: -webkit-fill-available;
    align-items: center;
    justify-content: center;
    }

    .komentar {
    width: -webkit-fill-available;
    }

    .komentar textarea {
    width: -webkit-fill-available;
    }
    .btn-review {
    width: -webkit-fill-available;
    background-color: #3a5db4;
    border:none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    }

    .btn-review:hover,
    .btn-review:active {
    background-color: #2f4da1;
    }
</style>
@foreach (var item in DtOrder)
{
    <div class="card-modern">
        <!-- Header -->
        <div class="card-header">
            <span class="status-badge @(item.IsCancel ? "cancel" :!item.IsPaid ? "waiting" :item.IsDone ? "done" :item.IsAktif ? "active" : "")">@GetStatusOrder(item)</span>
            <span class="time-label">
                @GetFormattedDate(item.TanggalPemesanan)
            </span>
        </div>

        <!-- Customer -->
        <div class="card-customer">
            <div class="customer-info">
                <img src="https://randomuser.me/api/portraits/women/39.jpg" alt="Avatar">
                <div>
                    <div class="customer-name">@item.Mentor_Nama</div>
                    <div class="customer-role">@item.Mentor_Alamat</div>
                </div>
            </div>
            @if ((item.IsAktif || item.IsPaid) && !item.IsDone)
            {
                <div style="display: flex; gap: 8px;">
                    <div class="action-order">
                        <span class="material-symbols-outlined">
                            call
                        </span>
                    </div>
                    <div class="action-order">
                        <span class="material-symbols-outlined">
                            chat
                        </span>
                    </div>
                </div>
            }
        </div>
        @if (item.IsAktif && !item.IsDone && RcpUtama.User.Role != "Mentor")
        {
            <!-- Footer -->
            <div class="card-footer">
                <span></span>
                <button class="btn-action" @onclick="(() => { ProsesSelesaikanPesanan(item); })">
                    Selesai
                </button>
            </div>
        }

    </div>

}

<PthBottomSheet @ref="BottomSheetReview">
    <div class="max-w-sm mx-auto mt-10 p-6 bg-white rounded-xl shadow-md relative">
        <!-- Tap to rate -->
        <p class="text-sm mb-2" style="font-size: 16px;font-weight: 600;">Tap to rate</p>

        <!-- Stars Placeholder (can be made interactive later) -->
        <div class="space-x-1 mb-4 rating-place">
            @for (int i = 0; i < 5; i++)
            {
                var index = i;  // Salin ke variabel lokal agar tidak tertimpa
                <span @onclick="() => SetRating(index + 1)"
                style="font-size: 40px; color:@(index < currentRating ? "gold" : "gray")"
                class="material-symbols-sharp cursor-pointer">
                    <i class="fa @(i < currentRating ? "fa-star" : "fa regular fa-star")" aria-hidden="true"></i>
                </span>
            }
        </div>


        <div class="komentar">
            <p class="text-sm mb-2" style="font-size: 16px;font-weight: 600;">Tell us more (optional)</p>
            <textarea @bind="Komentar" placeholder="Ceritakan mengapa kamu memberi rating ini" class="w-full border border-gray-300 rounded-md p-2 text-sm mb-4 resize-none"></textarea>
        </div>


        <!-- Submit Button -->
        <button class="text-white py-2 text-sm font-semibold btn-review" @onclick="@ProsesRating">Selesaikan Pesanan</button>
    </div>

</PthBottomSheet>

@code {
    [CascadingParameter]
    public RcpUtama RcpUtama { get; set; }
    public PthBottomSheet BottomSheetReview { get; set; }
    private List<T1Order> DtOrder = new();
    private T1Order DrOrderDipilih = new();

    protected override async Task OnInitializedAsync()
    {
        if (RcpUtama.User.Role != "Mentor" && !RcpUtama.User.Nama.Contains("Tamu")) DtOrder = RcpUtama.DbContext.Set<T1Order>().Where(x => x.IdSiswa == RcpUtama.User.IdSiswa).OrderBy(x => x.TanggalPemesanan).ToList();

        else if (!RcpUtama.User.Nama.Contains("Tamu")) DtOrder = RcpUtama.DbContext.Set<T1Order>().Where(x => x.IdMentor == RcpUtama.User.IdMentor).OrderBy(x => x.TanggalPemesanan).ToList();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {

        }
    }

    public string GetStatusOrder(T1Order order)
    {
        if (order.IsCancel)
            return "Dibatalkan";

        if (!order.IsPaid)
            return "Menunggu Pembayaran";

        if (order.IsDone)
            return "Selesai";

        if (order.IsAktif)
            return "Diproses";

        return "Status Tidak Diketahui";
    }

    public async Task ProsesSelesaikanPesanan(T1Order order)
    {
        DrOrderDipilih = order;
        BottomSheetReview.ShowBottomSheet();
    }

    #region Rating
    int currentRating = 0;
    string Komentar = "";

    void SetRating(int rating)
    {
        currentRating = rating;
        StateHasChanged();
    }
    async Task ProsesRating()
    {
        var rating = new T2Rating
        {
            IdOrder = DrOrderDipilih.IdOrder,
            Skor = currentRating,
            Komentar = Komentar,
        };

        DrOrderDipilih.IsDone = true;
        RcpUtama.DbContext.T1Order.Update(DrOrderDipilih);
        RcpUtama.DbContext.T2Rating.Add(rating);
        await RcpUtama.DbContext.SaveChangesAsync();
        StateHasChanged();
        BottomSheetReview.HideBottomSheet();
    }
    #endregion
}